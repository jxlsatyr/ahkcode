#Persistent
#SingleInstance, Force
SetBatchLines, -1
#Include DicomDuplicateDecrypt.ahk
#Include MySQL.ahk
#Include JSON.ahk
#Include HTTPRequest.ahk

; 每10分钟查询是否有PR导出完成的任务
SetTimer, PRRecoverImport, 10000

PRRecoverImport:
MySQL := new MySQL()
SQL := "SELECT id, tenant_id, project_id, src_accno, version FROM t_dicom_export WHERE is_deleted = 0 AND status = 6 AND decrypted = 0 AND dst_type = 'toMoveRecoverExp' ORDER BY create_time ASC LIMIT 10"
Objs := Query(SQL)
Loop % Objs.Length()
{
	ID := Objs[A_Index].id
	if (!ID) {
		return
	}
	TenantID := Objs[A_Index].tenant_id
	ProjectID := Objs[A_Index].project_id
	SrcAccno := Objs[A_Index].src_accno
	Version := Objs[A_Index].version
	
	SQL := "SELECT zip_file_path FROM t_dicom_export WHERE is_deleted = 0 AND status = 6 AND dst_type = 'toMovePr' AND project_id = '" ProjectID "'"
	Results := Query(SQL)
	if (Results.Length() <= 0) {
		return
	}
	ZipFilePath := Results[1].zip_file_path
	; 当前访视开始解密
	SQL := "UPDATE t_dicom_export SET decrypted = 1, version = version + 1, update_time = now() WHERE id = '" ID "' AND version = " Version
	Rows := Update(SQL)
	if (Rows > 0) {
		; 需要解压的文件路径
		ZipFilePath := StrReplace(StrReplace(ZipFilePath, "/data/eimage", "z:"), "/", "\") 
		SrcPath := ZipFilePath "\dcmRecoverFull\" SrcAccno
		if FileExist(SrcPath) {
			DecryptPath := ZipFilePath "\dcmRecoverFull_decoded\" SrcAccno
			FileRemoveDir, %DecryptPath%, 1
			Obj := new DicomDuplicateDecrypt(TenantID, ProjectID, SrcPath, DecryptPath, SrcAccno)
			obj.Start()
		}
	}
}
return